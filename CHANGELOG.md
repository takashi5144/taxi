# 変更履歴 (CHANGELOG)

## [1.3.6] - 2026-02-28

### 機能追加
- 売上記録の乗車時間UIの下に「待機乗車」機能を追加
  - 乗車時間を記録後、お客様が実際に乗車したタイミングで「待機乗車」ボタンを押すと待機時間を自動計算
  - 乗車時間からの経過時間を「N分」または「N時間M分」形式で記録
  - 待機中は案内メッセージを表示（乗車時間未設定時はボタン無効化）
  - クリアボタンで待機時間をリセット可能
  - 記録一覧に待機時間バッジをオレンジ色で表示
  - CSVエクスポートに待機時間カラムを追加
  - データにwaitingTimeフィールドとして保存

## [1.3.5] - 2026-02-28

### 機能追加
- 支払方法に「DIDI決済」を追加（現金・未収に加えて3択に拡張）
  - オレンジ色のスマートフォンアイコンで表示
  - 本日の売上合計に DIDI決済の件数・金額を独立カードで表示
  - DIDI決済は未収にも合算される（件数・金額ともに未収に含まれる）
  - 記録一覧に「DIDI決済」バッジをオレンジ色で表示
  - CSVエクスポートで「DIDI決済」として出力
  - 件数内訳にDIDI件数を表示

## [1.0.2] - 2026-02-24

### 機能追加
- 売上分析ページに「用途別」タブを追加
  - 用途×曜日ヒートマップ: 各用途がどの曜日に多いかを色の濃さで可視化
  - 日種別×用途分析: 平日・休日・大型連休（3日以上連続休日）ごとの乗車用途傾向を積み上げバーで表示
  - 今後30日間の用途予測: 曜日パターン(60%)と日種別パターン(40%)の加重スコアで予測、上位3用途を表示
  - 月別用途トレンド: 月×用途の件数推移をヒートマップ表で表示
- DataServiceに`getPurposeDayAnalysis()`メソッドを追加
  - JapaneseHolidaysと連携した大型連休判定ロジック搭載

## [1.0.1] - 2026-02-24

### バグ修正
- 日付の自動取得がUTC基準だったため、午前0時〜8時59分（JST）に前日の日付が表示されるバグを修正
  - `toISOString().split('T')[0]`（UTC）→ `getLocalDateString()`（ローカル時間）に全面置換
  - 売上記録・他社乗車・イベント・データ管理・祝日計算など全30箇所を修正
- アプリ復帰時（バックグラウンドから戻った時）にフォームの日付を自動更新するよう改善
  - visibilitychangeイベントで日付が変わっていたら自動でフォームの日付を最新化
- フォーム送信後のリセットでも送信時点の最新日付を使用するよう修正

## [1.0.0] - 2026-02-24

### 機能追加
- 売上記録ページに「始業ボタン」を追加
  - 日付フィールドの直下に配置
  - 始業ボタンを押すと現在時刻が始業時間として記録される
  - 次の始業ボタン押下時に前回シフトの終業時間を自動計算（直前の売上記録の時刻）
  - 始業中は経過時間をリアルタイム表示（緑色のステータス表示）
  - シフトデータはlocalStorageに永続保存（`taxi_app_shifts`キー）

### ヒートマップ改善
- ヒートマップを「半径2kmオーバーラップ方式」に刷新
  - 各乗車地点から半径2km圏内に約200m間隔のグリッドポイントを生成
  - ガウシアン減衰（σ=0.8km）で中心ほど高密度、外縁に向かって自然に減衰
  - 複数の乗車地点の2km圏が重なるエリアほど高いweightが累積 → 乗車率の高いエリアが一目で判別可能
  - ズームレベルに応じたピクセル半径の自動計算（メルカトル投影対応）
  - 青→緑→黄→橙→赤の6段階グラデーションで密度差を直感的に可視化

## [0.8.7] - 2026-02-22

### 機能追加
- データ管理の売上手動入力フォームに音声入力機能を追加
  - Web Speech API（日本語）を使用した音声認識
  - 「3500円 新宿から渋谷 通勤 男性1名 Go 晴れ」のように発話すると各フィールドに自動入力
  - 金額・乗車地・降車地・用途・性別・人数・配車方法・天候をパース
  - リアルタイム認識テキスト表示（録音中）
  - パース成功時のチェックマーク表示
  - 全角数字の半角変換、「買い物」→「買物」の正規化に対応
  - Speech API非対応ブラウザではボタンを非表示

## [0.8.6] - 2026-02-22

### UI改善
- データ管理の売上手動入力フォームの「用途」フィールドをチップ式選択UIに変更
  - 通勤/通院/買物/観光/出張/送迎/空港/飲食/その他 の9種をアイコン付きボタンで選択
  - 売上記録ページと同じUIに統一
  - タップで選択/再タップで解除のトグル動作

## [0.8.5] - 2026-02-22

### 機能追加
- データ変更時のヒートマップ・単価マップ自動更新
  - 売上記録・他社乗車記録・交通情報のCRUD操作後、表示中のレイヤーを自動再描画
  - カスタムイベント `taxi-data-changed` による疎結合な通知アーキテクチャ
  - ヒートマップ: データ追加/削除時にリアルタイムでポイント更新
  - 単価マップ: データ変更時にマーカー再生成＋周辺推定値を再計算
  - AI需要予測・AI単価予測は再学習コストが高いため手動トグルのまま

## [0.8.4] - 2026-02-22

### バグ修正
- エリア×時間帯クロス分析のスプレッド演算子記述ミス修正（`..` → `...`）— アプリ起動不能の原因
- 地図ページの単価マップ/AI単価予測ボタンがflexコンテナ外に配置されていたレイアウト崩れを修正
- 業務予測タブのセクションD（配車方法・用途分析）とE（クロス分析）の表示順序を修正

## [0.8.3] - 2026-02-22

### 機能追加
- 地図ページに「AI単価予測」レイヤーを追加
  - LightGBMモデルで位置×時間帯×曜日×天候から客単価を予測
  - 予測結果を3段階（緑/黄/赤）の円で地図上にオーバーレイ表示
  - 需要予測（既存）と単価予測を同時に使用可能
- 時間帯シミュレーション スライダーを追加
  - 0時〜23時のスライダーで未来の時間帯をシミュレーション
  - AI需要予測・AI単価予測の両方に連動
  - 「2時間後にどこが高単価か」を事前に確認可能
  - 現在時刻との差分表示（例: 「3時間後」「2時間前」）

### LightGBMService拡張
- `trainPriceModel()` — 単価予測用モデル学習（金額を目的変数として学習）
- `predictPriceGrid()` — グリッド上の単価予測（単価ランク付き）

## [0.8.2] - 2026-02-22

### 機能追加
- 地図ページに「単価マップ」レイヤーを追加
- GPS座標付きの乗車データを単価ランク別に色分けマーカーで地図上に表示
  - 緑（小）= ¥1,000以下 / 黄（中）= ¥1,001〜1,999 / 赤（大）= ¥2,000以上
- 配車方法フィルター: 全て/Go/Uber/DIDI/電話/流しで絞り込み可能
- 現在地周辺（半径2km）の推定客単価・過去データ件数・単価構成・配車方法内訳を表示
- 凡例付きで直感的にエリアの単価傾向を把握可能

### DataService拡張
- `getPriceTierHeatmapData(filterSource)` — 単価ランク別の地図用データ取得
- `getNearbyEstimate(lat, lng, radiusKm)` — 現在地周辺の推定客単価算出

## [0.8.1] - 2026-02-22

### 機能追加
- 業務予測タブに「配車方法×エリア×単価 クロス分析」セクションを追加
- 客単価を3段階に分類: ¥1,000以下（短距離）/ ¥1,001〜1,999（中距離）/ ¥2,000以上（長距離）
- 配車方法×エリア マトリクステーブル: 各セルに平均単価+単価ランク内訳バーを表示
- 配車方法別 単価ランク構成: 積み上げバーでGo/Uber/DIDI/電話/流しの単価分布を可視化
- エリア別 単価ランク構成: 各エリアの短距離/中距離/長距離比率を可視化

### DataService拡張
- `getSourceAreaPriceBreakdown()` — 配車方法×エリア×単価ランクのクロス集計

## [0.8.0] - 2026-02-22

### 機能追加
- 売上分析ページに「業務予測」タブを追加
- 今日のおすすめ: 現在の曜日・時間帯に基づく推定客単価、売上が高いエリアTOP3、単価が高い時間帯TOP3を表示
- エリア×時間帯クロス分析: 上位5エリアの時間帯別ヒートマップ風テーブル（4時間ごとに集約）
- 客単価分析: 曜日別・時間帯別・用途別・人数別の平均客単価をグラフ表示
- 配車方法・用途分析: 配車方法別（Go/Uber/DIDI/電話/流し）と用途別の件数・売上・平均単価を表示

### DataService拡張
- `getSourceBreakdown()` — 配車方法別集計
- `getPurposeBreakdown()` — 用途別集計
- `getAreaTimeBreakdown()` — エリア×時間帯クロス集計
- `getUnitPriceAnalysis()` — 客単価分析（曜日/時間帯/天候/用途/人数別）
- `getBusinessRecommendation()` — 今日のおすすめ（リアルタイム業務推奨）

## [0.7.4] - 2026-02-21

### UI改善
- 売上記録フォームのフィールド順序を変更: 乗車地→乗車時間→降車地→降車時間→日付→天候→配車方法→金額→人数→性別→用途→メモ
- 配車方法フィールドを追加（Go / Uber / DIDI / 電話 / 流し）
- 記録一覧に配車方法の表示を追加

## [0.7.3] - 2026-02-21

### バグ修正
- ファイルエクスポート・自動保存のバージョン文字列がハードコード(`'0.7.1'`)のまま更新されない問題を修正
- `APP_CONSTANTS.VERSION`を参照するよう変更（今後のバージョンアップ時に自動追従）

### 税内訳表示の拡充
- 売上分析ページ全セクション（累計・月別・曜日別・エリア別・天候別）に税込/税抜/消費税表示を追加
- ダッシュボード累計実績カードに税内訳を追加

## [0.7.2] - 2026-02-21

### クラウド同期の自動化
- DataServiceに`autoSync()`関数を追加（revenue/rivalを並行取得・マージ）
- アプリ起動時にクラウドから自動同期（SYNC_SECRET設定時のみ）
- タブ復帰時（visibilitychange）に自動同期
- 5分間隔の定期同期
- Settings画面に自動同期ステータス表示（有効/無効）

## [0.7.1] - 2026-02-21

### 修正
- 地図ピッカーの逆ジオコーディング改善: 日本語住所の階層（都道府県/市区/町名/丁目/番地）を正しく抽出する`_extractAddress`関数追加
- Geocoder結果からstreet_address/premise等の最も詳細な結果を優先選択
- Nominatimフォールバックにquarter・house_numberを追加

### GPS精度改善
- GPS初回取得に`getAccuratePosition`使用（複数回測位から最良を選択）
- `maximumAge: 0`でキャッシュ済み位置を使わないよう変更
- 精度に応じたマーカー色変更（青=高精度/黄=中精度/赤=低精度）
- 精度圏の色・透明度も精度レベルに連動
- 低精度時のズームレベル自動調整（1km超→zoom13）
- 地図上に精度低下警告オーバーレイ表示（1km超）
- GPSパネルに精度レベル表記（高精度/中精度/低精度）追加
- PC環境での低精度時に案内メッセージ表示

## [0.7.0] - 2026-02-21

### バグ修正
- `_gmapLoader`スコープ修正（Settings画面でのReferenceError解消）
- CSS変数 `--bg-secondary`/`--bg-tertiary` 追加（DataManage背景透過修正）
- `.btn--ghost` CSSクラス追加
- `saveEdit` transitタブ対応（未定義result参照クラッシュ修正）
- ID生成を`Date.now()+random`化（ミリ秒衝突防止）
- DataServiceの`useMemo`化（Revenue/RivalRide/Eventsの毎レンダーJSON.parse防止）

### セキュリティ
- API診断ログ削除・エラー詳細漏洩防止
- セキュリティヘッダー追加（HSTS, X-Frame-Options, X-Content-Type-Options等）

### UX改善
- 他社乗車フォームに送信ボタン追加
- バージョン番号を全ファイルで統一

### 保守
- SW簡素化（index.html+アイコンのみキャッシュ）
- obsoleteファイル削除（public/sw.js, public/manifest.json）
- src/ファイル同期（dataService 9関数追加, gemini export修正）

## [0.6.5] - 2026-02-21

### 機能追加
- 売上記録に配車方法（source）フィールド追加: Go, Uber, DIDI, 電話, 流し
- マップピッカーにGPS現在地自動表示
- マップピッカーの高さを拡大（660px）・標準スタイルに変更

## [0.6.4] - 2026-02-21

### 機能追加
- データ管理の手動入力にマップピッカー追加（乗車地・降車地）
- 地図クリックで逆ジオコーディングにより住所を自動取得
- GPS座標もaddEntryに渡してヒートマップデータに反映

## [0.6.3] - 2026-02-21

### 機能追加
- データ管理に売上手動入力フォーム追加
- 金額・日付・天候・乗車地/時刻・降車地/時刻・人数・性別・目的・メモを手入力可能

## [0.6.2] - 2026-02-21

### UI改善
- ヘッダーナビを非表示にしサイドバーのみに統一

## [0.6.1] - 2026-02-21

### 機能追加
- DataManagePageコンポーネント新規追加（3タブ構成: 売上・他社・交通情報）
- 売上記録: 検索・インライン編集・個別削除・全削除
- 他社記録: 検索・インライン編集・個別削除・全削除
- 交通情報: カテゴリ別表示・個別削除・全削除
- DataServiceにupdateEntry/updateRivalEntry関数追加

## [0.6.0] - 2026-02-21

### 機能追加
- リアルタイム時給表示（Dashboard）
- 天候×売上相関分析（Analytics天候別タブ）
- プッシュ通知（Settings + TransitInfo遅延アラート）
- 他社乗車分析（Analytics他社分析タブ）
- 需要ヒートマップ（GPS座標永続化 + visualization API）
- LightGBM-style GBDT: ブラウザ内で学習・推論、AI需要予測ヒートマップ

## [0.5.3] - 2026-02-20

### 機能追加
- 公共交通機関情報をGPS現在地の地域に基づいて取得
- 交通情報を「公共交通機関情報」サブフォルダに自動保存（日時付きファイル名）

### バグ修正
- 売上記録GPS取得時のクラッシュを修正

## [0.5.2] - 2026-02-20

### 改善
- TransitInfo新UI + GeminiService拡張をindex.htmlにインライン反映
- STORAGE_KEYS.TRANSIT_INFO追加（localStorage保存対応）

## [0.5.1] - 2026-02-20

### 機能追加
- 公共交通機関情報UIを大幅改善
- 4カテゴリタブ + Geminiレスポンス整形表示
- localStorage保存・取得済みインジケーター

## [0.5.0] - 2026-02-20

### 機能追加
- 公共交通機関情報ページをリニューアル
- GeminiService: fetchTrainInfo/fetchBusInfo/fetchFlightInfo/fetchTroubleInfo追加
- 大容量レスポンス用callGeminiLarge追加

## [0.4.1] - 2026-02-20

### 改善
- 公共交通機関ページを簡素化（Gemini AI検索のみに）

### セキュリティ
- CORS設定を自ドメイン限定に変更
- クラウド同期にAuthorization Bearer認証を必須化
- Google Maps APIキー入力をtype="password"に変更
- Gemini APIキーをURLパラメータからx-goog-api-keyヘッダーに移動

## [0.4.0] - 2026-02-19

### 機能追加
- 他社乗車情報ページ追加
- 保存フォルダをサブフォルダ構成に変更
- Gemini AI API統合（交通情報・イベントのAI検索）
- Android PWA対応（インストール・オフライン利用可能）
- GPS精度改善（enableHighAccuracy, getAccuratePosition）

## [0.3.3] - 2026-02-19

### 初回コミット
- タクシー売上サポートアプリ初回コミット

## [0.2.0] - 2026-02-17

### セキュリティ修正
- ハードコードされたGoogle Maps APIキーを削除

### 構造改善
- TaxiApp名前空間を導入
- ハッシュベースのURLルーティングを実装
- Service Workerによるオフラインキャッシュ対応（PWA）

### 機能追加
- 売上データのlocalStorage永続化
- 売上記録の削除機能
- 本日/累計の売上集計表示

## [0.1.0] - 2026-02-16

### 追加
- プロジェクト初期セットアップ (React + Vite)
- Google Maps統合
- GPS現在地取得機能
- レスポンシブUI（PC/Android対応）
- 開発者ツール（ログビューア、サイト構造ビューア）
- PWA基本設定
